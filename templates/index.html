<!DOCTYPE html>
<html>
<head>
    <title>AWS Bedrock 챗봇</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #messages { border: 1px solid #ddd; padding: 10px; min-height: 300px; max-height: 400px; overflow-y: auto; margin-bottom: 10px; background-color: #e9ecef; border-radius: 4px; }
        .message-user { text-align: right; color: #007bff; margin-bottom: 5px; }
        .message-bot { text-align: left; color: #28a745; margin-bottom: 5px; }
        input[type="text"] { width: calc(100% - 100px); padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-right: 5px; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>AWS Bedrock 실시간 챗봇</h1>
        <div id="messages"></div>
        <input type="text" id="messageInput" placeholder="메시지를 입력하세요..." onkeyup="if(event.keyCode === 13) sendMessage()">
        <button onclick="sendMessage()">보내기</button>
    </div>

    <script>
        // 웹소켓 URL은 현재 웹페이지의 프로토콜과 호스트를 사용합니다.
        // AWS 배포 시에는 자동으로 해당 URL로 연결됩니다.
        var ws_protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        var ws_url = ws_protocol + '//' + window.location.host + '/ws';
        var ws = new WebSocket(ws_url);

        ws.onopen = function(event) {
            console.log("WebSocket 연결 성공");
        };

        ws.onmessage = function(event) {
            var messagesDiv = document.getElementById("messages");
            // 새로운 메시지를 추가하는 대신, 마지막 봇 응답에 텍스트를 이어 붙입니다.
            // 이렇게 하면 스트리밍되는 텍스트가 자연스럽게 나타납니다.
            var lastBotMessage = messagesDiv.querySelector('.message-bot:last-child');
            if (lastBotMessage && !lastBotMessage.dataset.complete) {
                lastBotMessage.textContent += event.data;
            } else {
                var p = document.createElement("p");
                p.className = "message-bot";
                p.textContent = event.data;
                messagesDiv.appendChild(p);
            }
            messagesDiv.scrollTop = messagesDiv.scrollHeight; // 스크롤을 최하단으로
        };

        ws.onclose = function(event) {
            console.log("WebSocket 연결 종료:", event);
            var messagesDiv = document.getElementById("messages");
            messagesDiv.innerHTML += "<p style='color: red;'><strong>연결이 끊어졌습니다. 페이지를 새로고침하세요.</strong></p>";
        };

        ws.onerror = function(event) {
            console.error("WebSocket 에러:", event);
            var messagesDiv = document.getElementById("messages");
            messagesDiv.innerHTML += "<p style='color: red;'><strong>WebSocket 에러 발생.</strong></p>";
        };

        function sendMessage() {
            var input = document.getElementById("messageInput");
            var message = input.value.trim();
            if (message) {
                ws.send(message);
                var messagesDiv = document.getElementById("messages");
                var p = document.createElement("p");
                p.className = "message-user";
                p.textContent = message;
                messagesDiv.appendChild(p);
                input.value = ""; // 입력 필드 초기화
                messagesDiv.scrollTop = messagesDiv.scrollHeight; // 스크롤을 최하단으로
            }
        }
    </script>
</body>
</html>